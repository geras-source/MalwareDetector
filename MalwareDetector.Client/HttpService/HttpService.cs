using Microsoft.AspNetCore.Http.Internal;
using Microsoft.Extensions.Configuration;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Threading.Tasks;

namespace MalwareDetector.Client.HttpService
{
    internal class HttpService
    {
        private static HttpClient _httpClient = new HttpClient();
        /// <summary>
        /// Конструктор задает базовый адрес универсального кода ресурса
        /// </summary>
        /// <param name="configuration">Файл конфигурации</param>
        public HttpService(IConfiguration configuration)
        {
            _httpClient.BaseAddress = new Uri(configuration["ConnectionStrings:ConnectingToServer"]);
        }

        /// <summary>
        /// Получить статус сканирования c помощью идентификатора
        /// </summary>
        /// <param name="id">Идентификатор</param>
        /// <returns>Отчет</returns>
        internal async Task<string> GetStatusScan(string id)
        {
            var response = await _httpClient.GetAsync($"{_httpClient.BaseAddress}/{id}");
            return await response.Content.ReadAsStringAsync();
        }

        /// <summary>
        /// Конвертировать файлы и отправить их на сканирование
        /// </summary>
        /// <param name="pathDirectory">Путь директории для сканирования</param>
        /// <returns>Идентификатор сканирования</returns>
        internal async Task<string> SendFilesToScan(string pathDirectory)
        {
            var filesPath = Directory.GetFiles(pathDirectory, "*", SearchOption.AllDirectories).ToList();
            try
            {
                var files = ConvertToFormFile(filesPath);

                var content = new MultipartFormDataContent();
                foreach (var file in files)
                {
                    var fileContent = new StreamContent(file.OpenReadStream());
                    fileContent.Headers.ContentDisposition = new ContentDispositionHeaderValue("form-data")
                    {
                        Name = "formFiles",
                        FileName = file.FileName
                    };
                    content.Add(fileContent);
                }
                content.Add(new StringContent(pathDirectory), "pathDirectory");
                var response = await _httpClient.PostAsync(_httpClient.BaseAddress, content);
                return await response.Content.ReadAsStringAsync();
            }
            catch
            {
                return "Exception";
            }
           
        }

        /// <summary>
        /// Конвертор файлов для отправки в запросе
        /// </summary>
        /// <param name="filesPath">Список файлов</param>
        /// <returns>Список файлов подготовленных для отправки</returns>
        private List<FormFile> ConvertToFormFile(List<string> filesPath)
        {
            var result = new List<FormFile>();
            foreach (var filePath in filesPath)
            {
                var stream = new MemoryStream(File.ReadAllBytes(filePath).ToArray());
                var file = new FormFile(stream, 0, stream.Length, filePath, Path.GetFileName(filePath));
                result.Add(file);
            }

            return result;
        }
    }
}